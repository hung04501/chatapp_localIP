<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
	 <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
	  #img1{
		width :50px;
		height :50px;
	  }
	  .container{
		max-height: 700px;
		background-color: pink;
		overflow: auto;
	  }
    </style>
	<link rel="stylesheet" href="./emotion/css/basic/emojify.css" />
	<script src="./emotion/emojify.js"></script>
	<script src="http://192.168.100.113:5000/socket.io/socket.io.js"></script>
	<script src="./emotion/jquery-latest.min.js"></script>
	
	
	
	<script>
//scroll


// NOTE: window.RTCPeerConnection is "not a constructor" in FF22/23
var RTCPeerConnection = /*window.RTCPeerConnection ||*/ window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
var ipClient;
if (RTCPeerConnection) (function () {
    var rtc = new RTCPeerConnection({iceServers:[]});
    if (1 || window.mozRTCPeerConnection) {      // FF [and now Chrome!] needs a channel/stream to proceed
        rtc.createDataChannel('', {reliable:false});
    };
    
    rtc.onicecandidate = function (evt) {
        // convert the candidate to SDP so we can run it through our general parser
        // see https://twitter.com/lancestout/status/525796175425720320 for details
        if (evt.candidate) grepSDP("a="+evt.candidate.candidate);
    };
    rtc.createOffer(function (offerDesc) {
        grepSDP(offerDesc.sdp);
        rtc.setLocalDescription(offerDesc);
    }, function (e) { console.warn("offer failed", e); });
    
    
    var addrs = Object.create(null);
    addrs["0.0.0.0"] = false;
    function updateDisplay(newAddr) {
        if (newAddr in addrs) return;
        else addrs[newAddr] = true;
        var displayAddrs = Object.keys(addrs).filter(function (k) { return addrs[k]; });
        document.getElementById('list').textContent = displayAddrs.join(" or perhaps ") ;
		ipClient = displayAddrs.join(" or perhaps ") ;
		
    }
    
    function grepSDP(sdp) {
        var hosts = [];
        sdp.split('\r\n').forEach(function (line) { // c.f. http://tools.ietf.org/html/rfc4566#page-39
            if (~line.indexOf("a=candidate")) {     // http://tools.ietf.org/html/rfc4566#section-5.13
                var parts = line.split(' '),        // http://tools.ietf.org/html/rfc5245#section-15.1
                    addr = parts[4],
                    type = parts[7];
                if (type === 'host') updateDisplay(addr);
            } else if (~line.indexOf("c=")) {       // http://tools.ietf.org/html/rfc4566#section-5.7
                var parts = line.split(' '),
                    addr = parts[2];
                updateDisplay(addr);
            }
        });
    }
})(); else {
    document.getElementById('list').innerHTML = "<code>ifconfig | grep inet | grep -v inet6 | cut -d\" \" -f2 | tail -n1</code>";
    document.getElementById('list').nextSibling.textContent = "In Chrome and Firefox your IP should display automatically, by the power of WebRTCskull.";
}

		
</script>
  </head>
  <body id="site-body">
  <h1>WELCOME TO CHAT ROOM <br/></h1>
  Your network IP is: <h2 id="list"></h2> 
  
   <div id="listuser" style="width:20%;float:left;background-color:green">
   fsfsf
    <div id="room" value="roomOne">roomOne</div>
	<div id="roomAll" value="roomOne">roomAll</div>
</div>   
  <div class="container" style="width:80%;float:right">
  
	<div id="messages"></div>
	<div id="messages_room"></div>
	 
	  <div id="my-element"></div>
	  
	<script>
		
		//notification
		function notifyMe(user,message) {
		  // Let's check if the browser supports notifications
		  if (!("Notification" in window)) {
			alert("This browser does not support desktop notification");
		  }

		  // Let's check whether notification permissions have already been granted
		  else if (Notification.permission === "granted") {
			// If it's okay let's create a notification
			<!-- var options = { body: randomQuote, icon: 'img/sad_head.png', } -->
			var n = new Notification(user.username, {body: message, icon: "img.jpg" }); 
			
			//click focus window chat and close notification popup
			n.onclick = function(){ window.focus(); this.close(); };
			
			//set time out close popup notification
			setTimeout(n.close.bind(n), 5000); 
			
		  }

		  // Otherwise, we need to ask the user for permission
		  else if (Notification.permission !== 'denied') {
			Notification.requestPermission(function (permission) {
			  // If the user accepts, let's create a notification
			  if (permission === "granted") { 
				var n = new Notification(user.username, {body: message, icon: "img.jpg" }); 
				setTimeout(n.close.bind(n), 5000);
			  }
			});
		  }

		  // At last, if the user has denied notifications, and you 
		  // want to be respectful there is no need to bother them any more.
		}
		
		//update in tab browser
		
		var count = 0;
		var title = document.title;
		var update;
		function changeTitle() {
			if(count > 0) {
				var newTitle = '(' + count + ') ' + title;
				document.title = newTitle;
				
			}
		}

		function newUpdate() {
			count = 0;
			update = setInterval(changeTitle, 1000);
		}
		
		//clear notification when user active
		$(window).blur(newUpdate);

		$(window).focus(function() {
			$('#msg').focus();
			clearInterval(update);
			setInterval(function() {
				document.title = title;
			},2000);
			count = 0;
		});
		
		//format message
		function escaped(s) {
          return $("<div></div>").html(s).html();
        }
		 var socket = io.connect('http://192.168.100.113:5000');
		//nickname
		socket.on('nickname', function (data) {
				$('#urnickname').append(data.toString());
		});
		//show all chat
		socket.on('showallchat', function (messages) {
			str_message = "";
			if (messages.length) {
				str_message += '<b>'+ escaped(messages[0].clientName) + ':</b> ' + escaped(messages[0].message) + "<br/>" + escaped(messages[0].timechat) + "<br/>";
			}
			for (var i= 1;i< messages.length;i++) {
				if(messages[i].clientName != messages[i-1].clientName) {
					str_message += '<b>'+ escaped(messages[i].clientName) + ':';
				}
				str_message += '</b> ' + escaped(messages[i].message) + "<br/>" + escaped(messages[i].timechat) + "<br/>";
			}
			$('#messages').append(str_message);
		
		});
		
		//new message
		var userNotification;
		socket.on('updatechat', function (user, data) {
				count ++;
				str_msg = "";
				//send all exception user 
				if(ipClient != user.ipClient){
					notifyMe(user,data);
				}
				//check last client send msg
				if(user.same) {
					str_msg+='</b> ' + escaped(data) + "<br/>" + escaped(user.timechat) + "<br/>";
				} else{
					str_msg+='<b>'+ escaped(user.username) + ':</b> ';
				}
				$('#messages').append(str_msg);
				
				
				userNotification = user.username;
				
				//constant emojify
				emojify.setConfig({
					emojify_tag_type : 'div',           // Only run emojify.js on this element
					only_crawl_id    : null,            // Use to restrict where emojify.js applies
					img_dir          : './emotion/images/emoji',  // Directory for emoji images
					ignored_tags     : {                // Ignore the following tags
						'SCRIPT'  : 1,
						'TEXTAREA': 1,
						'A'       : 1,
						'PRE'     : 1,
						'CODE'    : 1
					}
				});
				
				//run emojify
				emojify.run(document.getElementById('messages'));
				//scroll bottom when add more text
				var objDiv = $('.container');
				if (objDiv.length > 0){
					objDiv[0].scrollTop = objDiv[0].scrollHeight;
				}
				console.log(user.ipClient);
				console.log(ipClient);
		});

			
		 $(function(){
			//join room
			 socket.on('message_room', function (data) {
			  console.log(data);
			  $('#messages_room').append(data);
			 });
			
			
			$('#room').click(function() {
			 socket.emit('subscribe_room', 'roomOne');
			 $('#messages').text('');
			 });
			$('#roomAll').click(function() {
			 socket.emit('unsubscribe_room', 'roomOne');
			 $('#messages').text('');
			});

			 $('#btnsend_room').click(function() {
			  var room = $('#room').text(),
			   message = $('#msg_room').val();
				console.log(room);
				console.log(message);
			  socket.emit('sendmsg_room', { room: room, message: message });
			 });
			 //end join room
          // when the client hits ENTER on their keyboard
          $('#msg').keypress(function(e) {
            if(e.which == 13) {
              var message = $('#msg').val();
              $('#msg').val('');
			  var messageDetails = {  
				ipClient : ipClient,  
				message : message 
				};
				
              // tell server to execute 'sendchat' and send along one parameter
			  /*$('#myForm').submit(function(e){
				 e.preventDefault(); 
				 var url=$(this).attr('action'), data=$(this).serialize(); 
				$.ajax({ 
					url:url, 
					type:'post', 
					data:data, 
					success:function()
					{ 
					//whatever you wanna do after the form is successfully submitted 

					} }); 
				});*/
              socket.emit('sendchat', messageDetails);

			
			  
			
            }
          });
		  
		  // when the client hits ENTER on their keyboard
          $('#btnsend').click(function(e) {
              var message = $('#msg').val();
              $('#msg').val('');
			  
			  var messageDetails = {  
				ipClient : ipClient,  
				message : message 
			};
              // tell server to execute 'sendchat' and send along one parameter
              socket.emit('sendchat', messageDetails);
			 
          });
		  
		  
        });

	</script>
	
	</div>
	<div style="clear:both;float:right">
	<input type="hidden" id="ipuser" name="ipclient" >
		  <input id="msg" name="message"/><button id="btnsend">Send</button>
		  <input id="msg_room" name="message"/><button id="btnsend_room">Send Room</button>
		  <input type="hidden" id="datechat" name ="timechat">
	</div>
	<script>

			
				var objDiv = $('.container');
				//alert(objDiv[0].scrollTop);
				if (objDiv.length > 0){
					objDiv.scrollTop = objDiv.scrollHeight;
				}

	
	
	</script>
  </body>
  
</html>



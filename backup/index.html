<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
	 <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
	  #img1{
		width :50px;
		height :50px;
	  }
    </style>
	<link rel="stylesheet" href="./emotion/css/basic/emojify.css" />
	<script src="./emotion/emojify.js"></script>
	<script src="http://192.168.100.113:5000/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	

	<script>
//get client ip 
// NOTE: window.RTCPeerConnection is "not a constructor" in FF22/23
var RTCPeerConnection = /*window.RTCPeerConnection ||*/ window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
var ipClient;
if (RTCPeerConnection) (function () {
    var rtc = new RTCPeerConnection({iceServers:[]});
    if (1 || window.mozRTCPeerConnection) {      // FF [and now Chrome!] needs a channel/stream to proceed
        rtc.createDataChannel('', {reliable:false});
    };
    
    rtc.onicecandidate = function (evt) {
        // convert the candidate to SDP so we can run it through our general parser
        // see https://twitter.com/lancestout/status/525796175425720320 for details
        if (evt.candidate) grepSDP("a="+evt.candidate.candidate);
    };
    rtc.createOffer(function (offerDesc) {
        grepSDP(offerDesc.sdp);
        rtc.setLocalDescription(offerDesc);
    }, function (e) { console.warn("offer failed", e); });
    
    
    var addrs = Object.create(null);
    addrs["0.0.0.0"] = false;
    function updateDisplay(newAddr) {
        if (newAddr in addrs) return;
        else addrs[newAddr] = true;
        var displayAddrs = Object.keys(addrs).filter(function (k) { return addrs[k]; });
        document.getElementById('list').textContent = displayAddrs.join(" or perhaps ") ;
		ipClient = displayAddrs.join(" or perhaps ") ;
		//send ip client to server
		//socket.emit('ipclient', displayAddrs.join(" or perhaps ") || "n/a");
    }
    
    function grepSDP(sdp) {
        var hosts = [];
        sdp.split('\r\n').forEach(function (line) { // c.f. http://tools.ietf.org/html/rfc4566#page-39
            if (~line.indexOf("a=candidate")) {     // http://tools.ietf.org/html/rfc4566#section-5.13
                var parts = line.split(' '),        // http://tools.ietf.org/html/rfc5245#section-15.1
                    addr = parts[4],
                    type = parts[7];
                if (type === 'host') updateDisplay(addr);
            } else if (~line.indexOf("c=")) {       // http://tools.ietf.org/html/rfc4566#section-5.7
                var parts = line.split(' '),
                    addr = parts[2];
                updateDisplay(addr);
            }
        });
    }
})(); else {
    document.getElementById('list').innerHTML = "<code>ifconfig | grep inet | grep -v inet6 | cut -d\" \" -f2 | tail -n1</code>";
    document.getElementById('list').nextSibling.textContent = "In Chrome and Firefox your IP should display automatically, by the power of WebRTCskull.";
}

		
</script>

<script>
function clickCounter() {
    if(typeof(Storage) !== "undefined") {
        if (sessionStorage.clickcount) {
            sessionStorage.clickcount = Number(sessionStorage.clickcount)+1;
        } else {
            sessionStorage.clickcount = 1;
        }
        document.getElementById("result").innerHTML = "You have clicked the button " + sessionStorage.clickcount + " time(s) in this session.";
    } else {
        document.getElementById("result").innerHTML = "Sorry, your browser does not support web storage...";
    }
}


</script>

  </head>
  <body id="site-body">
  Your network IP is: <h1 id="list"></h1> Make the locals proud.
   My nicknam is : <h1 id="urnickname"></h1> 
   
   <p><button onclick="clickCounter()" type="button">Click me!</button></p>
<div id="result"></div>
<p>Click the button to see the counter increase.</p>
<p>Close the browser tab (or window), and try again, and the counter is reset.</p>
   
   
<!--<div class="container">
  <form enctype="multipart/form-data" action="/upload" method="post">
	  <input type="file" name="photo" multiple />
	  <input type="submit" value="Upload Image" name="submit" />
	</form>
</div>-->
  <div class="container">
  <div id="img1"></div> 
	<div id="messages"></div>
	  <!--<input id="regusr"/><button id="btnReg">Register</button>-->
      <input id="msg"/><button id="btnsend">Send</button>
	  <div id="my-element"></div>
	  
	<script>
	
		//$(window).focus(function(){ //set focus to our text :D });
		//notification
		
				function notifyMe(user,message) {
		  // Let's check if the browser supports notifications
		  if (!("Notification" in window)) {
			alert("This browser does not support desktop notification");
		  }

		  // Let's check whether notification permissions have already been granted
		  else if (Notification.permission === "granted") {
			// If it's okay let's create a notification
			<!-- var options = { body: randomQuote, icon: 'img/sad_head.png', } -->
			var n = new Notification(user.username, {body: message, icon: "img.jpg" }); 
			
			//click focus window chat and close notification popup
			n.onclick = function(){ window.focus(); this.close(); };
			
			//set time out close popup notification
			setTimeout(n.close.bind(n), 5000); 
			
		  }

		  // Otherwise, we need to ask the user for permission
		  else if (Notification.permission !== 'denied') {
			Notification.requestPermission(function (permission) {
			  // If the user accepts, let's create a notification
			  if (permission === "granted") { 
				var n = new Notification(user.username, {body: message, icon: "img.jpg" }); 
				setTimeout(n.close.bind(n), 5000);
			  }
			});
		  }

		  // At last, if the user has denied notifications, and you 
		  // want to be respectful there is no need to bother them any more.
		}
		
		//update in tab browser
		
		var count = 0;
		var title = document.title;
		var update;
		function changeTitle() {
			if(count > 0) {
				var newTitle = '(' + count + ') ' + title;
				document.title = newTitle;
				
			}
		}

		function newUpdate() {
			count = 0;
			update = setInterval(changeTitle, 1000);
		}
		
		//clear notification when user active
		$(window).blur(newUpdate);

		$(window).focus(function() {
			$('#msg').focus();
			clearInterval(update);
			setInterval(function() {
				document.title = title;
			},2000);
			count = 0;
		});
		
		//format message
		function escaped(s) {
          return $("<div></div>").html(s).html();
        }
		 var socket = io.connect('http://192.168.100.113:5000');
		//nickname
		socket.on('nickname', function (data) {
				$('#urnickname').append(data.toString());
		});
		//new message
		var userNotification;
		socket.on('updatechat', function (user, data) {
				count ++;
				
				if(ipClient != user.ipClient){
					notifyMe(user,data);
				}
				userNotification = user.username;
				$('#messages').append('<b>'+ escaped(user.username) + ':</b> ' + escaped(data) + "<br/>" + escaped(user.timechat) + "<br/>");
				console.log(user.ipClient);
				console.log(ipClient);
		});
		
		//image
		
		socket.on('updateimage', function (data) {
				$('#img1').append('<img src="' + data.toString() + '"/>');
				console.log(data.toString());
		});
		

		
		 $(function(){
		 
		 /*
		 $('#regusr').keypress(function(e) {
            if(e.which == 13) {
              var username_i = $('#regusr').val();
              $('#regusr').val('');
              // tell server to execute 'register' and send along one parameter
              socket.emit('adduser', username_i);
            }
          });
		  */
		  
		  
		  emojify.setConfig({

    emojify_tag_type : 'div',           // Only run emojify.js on this element
    only_crawl_id    : null,            // Use to restrict where emojify.js applies
    img_dir          : './emotion/images/emoji',  // Directory for emoji images
    ignored_tags     : {                // Ignore the following tags
        'SCRIPT'  : 1,
        'TEXTAREA': 1,
        'A'       : 1,
        'PRE'     : 1,
        'CODE'    : 1
    }
});
          // when the client hits ENTER on their keyboard
          $('#msg').keypress(function(e) {
            if(e.which == 13) {
              var message = $('#msg').val();
              $('#msg').val('');
			  var messageDetails = {  
				ipClient : ipClient,  
				message : message 
				};
				emojify.run(document.getElementById('messages'));
              // tell server to execute 'sendchat' and send along one parameter
              socket.emit('sendchat', messageDetails);
            }
          });
		  
		  // when the client hits ENTER on their keyboard
          $('#btnsend').click(function(e) {
              var message = $('#msg').val();
              $('#msg').val('');
			  
			  var messageDetails = {  
				ipClient : ipClient,  
				message : message 
			};
			
			
			
			emojify.run(document.getElementById('messages'));
              // tell server to execute 'sendchat' and send along one parameter
              socket.emit('sendchat', messageDetails);
          });
        });

	</script>
	
	</div>
  </body>
</html>


